<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  

  
  <title>Ty-Chen&#39;s Home</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="Ty-Chen&#39;s Home">
<meta property="og:url" content="https://ty-chen.github.io/index.html">
<meta property="og:site_name" content="Ty-Chen&#39;s Home">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="Ty Chen">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="Ty-Chen&#39;s Home" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  
<link rel="stylesheet" href="/css/style.css">

<meta name="generator" content="Hexo 4.2.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Ty-Chen&#39;s Home</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">Collecting, sharing and creating knowledge</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="搜索"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="https://ty-chen.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-关于MMORPG多人对战中热点问题的解决思路讨论" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/18/%E5%85%B3%E4%BA%8EMMORPG%E5%A4%9A%E4%BA%BA%E5%AF%B9%E6%88%98%E4%B8%AD%E7%83%AD%E7%82%B9%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF%E8%AE%A8%E8%AE%BA/" class="article-date">
  <time datetime="2020-04-18T14:18:33.000Z" itemprop="datePublished">2020-04-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/18/%E5%85%B3%E4%BA%8EMMORPG%E5%A4%9A%E4%BA%BA%E5%AF%B9%E6%88%98%E4%B8%AD%E7%83%AD%E7%82%B9%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF%E8%AE%A8%E8%AE%BA/">关于MMORPG多人对战中热点问题的解决思路讨论</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一-引子"><a href="#一-引子" class="headerlink" title="一. 引子"></a>一. 引子</h3><p>&emsp;&emsp;本人是重度游戏爱好者，MMORPG当然也体验过很多，从早期的传奇、奇迹到冒险岛，从天下三、剑网三到天刀、逆水寒，其中有一个共同的问题：人一多就卡。拿剑网三举例，大攻防小攻防简直不要太卡，尤其是一波对冲，如果你不屏蔽人物、不降低画质，那简直就是在作死的边缘试探。为此，本文试分析如何解决MMORPG中多人对战造成的卡顿问题。</p>
<p>&emsp;&emsp;卡顿分为个人电脑卡顿和服务器卡顿两种。其中个人卡顿可能是由于显卡性能不够（引擎优化不够）、内存不足（客户端优化不够）、网络延迟高（大多数是因为网太垃圾了，也有可能是客户端服务端优化不足）等原因导致。<strong>这些不在本文的讨论范围内，因为每一个展开都会是极多极难的问题，本文仅专注于讨论大攻防时由于人多导致的服务器卡顿问题，即如何做到一个玩家在进行大规模对战时游戏体验和JJC以及战场体验接近或者相同的问题。</strong></p>
<h3 id="二-热点问题的由来和解决的痛点"><a href="#二-热点问题的由来和解决的痛点" class="headerlink" title="二. 热点问题的由来和解决的痛点"></a>二. 热点问题的由来和解决的痛点</h3><p>&emsp;&emsp;游戏发展到现在，对服务器来说瓶颈其实并不在于网速，而是在于当几百人对战时，一般会集中在一个很小的区域范围内攻击BOSS或者双方互相攻击。而这种情况下，每个人的技能、移动都需要计算，每个人受到的技能、别人的位置信息也需要实时更新，这些数据计算难以拆分、CPU也难以快速计算完成，因此造成了一个计算带来的延迟。这个延迟导致了逻辑帧帧率的下降，并因此导致了渲染帧的减少。为了追帧，就不得不做一些处理，因此在玩家严重就表现为大家突然静止，然后突然瞬移，或者产生快速移动现象。</p>
<p>&emsp;&emsp;由上，不难看出主要的问题在于单位时间内的计算量可谓是不低。以剑网三为例，在一次大攻防里，400对400人的战斗，还要考虑到特殊门派如五毒的宝宝、长歌的影子，可以假设是1000对1000，即每秒需要完成百万数量的技能计算。</p>
<p>&emsp;&emsp;有人会说，多开几个服务器不行吗？多几个电脑（CPU）一起算不就好了吗？这里不得不说，更糟糕的是，玩家释放技能会造成玩家之间有着强依赖关系，拆分起来有很多问题需要讨论。如A发出向B的攻击，B发出了向C的攻击。如果A的伤害足够击杀了B，则B对C的伤害如果在击杀之后则应该无效。如果将A、B、C拆分在不同的服务器上计算，那如何保证如例子中一般取消B对C的攻击伤害呢？如果通过服务器间通信来保证消息的一致性，通信的延时损耗和完成逻辑判断需要的开销会不会比拆分得到的收益更多呢？</p>
<p>&emsp;&emsp;因此，我们不可以将每个玩家都拆分出来单独计算，因为需要考虑玩家之前的强关联性，同时还要考虑拆分后为保证数据一致性的通信时延损耗。</p>
<p>&emsp;&emsp;对此，我觉得可以从以下两个角度着手考虑如何解决该问题。</p>
<ul>
<li>从分级合理拆分的角度考虑解决该问题</li>
<li>从优化流程的角度考虑解决该问题</li>
</ul>
<h3 id="三-分级合理拆分"><a href="#三-分级合理拆分" class="headerlink" title="三. 分级合理拆分"></a>三. 分级合理拆分</h3><ul>
<li><p>逻辑时间管理<br>&emsp;&emsp;拆分一大关键问题是同步问题，因此这里可以采用一个类似于lamport clock的自增逻辑时间来标记每秒内收到的所有玩家操作顺序，并以此顺序来作为后续拆分后一些先后顺序的判断：比如玩家释放的技能和玩家死亡时间的先后顺序。</p>
</li>
<li><p>拆分技能<br>&emsp;&emsp;在MMORPG游戏里技能一般分为两种：AOE技能和单体技能。为了减小计算量，我们可以将AOE技能单独拆出来而不作为玩家间关联的依据，而是判断玩家所处的坐标内是否有该技能效果。这里需要考虑伤害发起玩家如果死亡则伤害停止。</p>
</li>
<li><p>热点中的热点单独计算<br>&emsp;&emsp;在大型对人对战中，看似玩家间的攻击杂乱无章法，但是实际上大多数时候是有序的，如<br>（1）大攻防中的大小经营BOSS<br>（2）小攻防中的箭塔、战车、大旗<br>（3）被指挥标记的集火单位<br>&emsp;&emsp;这些单位存在一个共同特点：被大量单位集火，因此可以作为热点中的热点，单独进行计算。我们将该热点收到的技能伤害以逻辑时间为顺序列出，以哈希表 + 链表或者跳表的形式存储（空间换时间）。等待其他玩家是否有死亡信息发生在其释放技能之前的事件通知，若有则将其从该表中剔除，最终生成计算结果。</p>
</li>
<li><p>邻接表拆分关联玩家<br>&emsp;&emsp;这里可以模拟Trie树的思想，从一个dummy根开始，以邻接链表的方式将玩家进行分类，然后对dummy根的儿子们进行拆分计算。这些儿子的计算结果可以直接发送给对应玩家，同时发送一份死亡通知给3中的热点用以计算。</p>
</li>
</ul>
<h3 id="四-计算流程的优化"><a href="#四-计算流程的优化" class="headerlink" title="四. 计算流程的优化"></a>四. 计算流程的优化</h3><ul>
<li><p>优化技能和判断逻辑<br>&emsp;&emsp;这里的优化技能逻辑其实是针对开发流程中的策划来说的。在大型MMORPG团队中，一般技能等的释放、判断逻辑会交由策划通过编写脚本来完成，如python或者lua等等。这里其实可能存在两个问题<br>（1）策划一般不会精通算法，写出来的逻辑可能复杂度很高，每一处的高复杂度叠加后就会产生极大的不必要延迟<br>（2）脚本和C/C++的调用会产生时间成本<br>&emsp;&emsp;这里可能的优化方法有<br>（1）类似于 C++的stl，写一个基础库供以策划调用，避免了策划写出垃圾代码和大量低级BUG的问题<br>（2）做一个脚本编译转成C/C++的中间工具，解决问题（2）</p>
</li>
<li><p>服务器流程优化<br>&emsp;&emsp;最近在学习的时候了解到了一个近几年比较有新意的东西：DPDK(Data Plane Development Kit)。详细说明可见其<a href="https://software.intel.com/en-us/networking/dpdk" target="_blank" rel="noopener">官方说明</a>，另外这里有篇<a href="https://cloud.tencent.com/developer/article/1198333" target="_blank" rel="noopener">中文文献</a>写的也不错。<br>&emsp;&emsp;处理数据包的传统方式是CPU中断方式，即网卡驱动接收到数据包后通过中断通知CPU处理，然后由CPU拷贝数据并交给协议栈。在数据量大时，这种方式会产生大量CPU中断，导致CPU无法运行其他程序。而DPDK则采用轮询方式实现数据包处理过程：DPDK重载了网卡驱动，该驱动在收到数据包后不中断通知CPU，而是将数据包通过零拷贝技术存入内存，这时应用层程序就可以通过DPDK提供的接口，直接从内存读取数据包。<br>&emsp;&emsp;这种处理方式节省了CPU中断时间、内存拷贝时间，并向应用层提供了简单易行且高效的数据包处理方式，使得网络应用的开发更加方便。但同时，由于需要重载网卡驱动，因此该开发包目前只能用在部分采用Intel网络处理芯片的网卡中。<br>&emsp;&emsp;对于玩家来说，总体感知的时间是发包+处理数据+收包的过程。因此对任意部分如果可以进行一些比较显著的优化都会对整体效果起到比较好的表现。DPDK在收发包、数据处理方面都有着较多的优化，该部分如果有比较成熟的生态系统我相信对提高服务器表现绝对大有裨益。</p>
</li>
</ul>
<h3 id="五-总结"><a href="#五-总结" class="headerlink" title="五. 总结"></a>五. 总结</h3><p>&emsp;&emsp;由于本人缺乏很多方面的实际开发经验，本文仅从一个游戏玩家的角度进行分析，一定有很多有失偏颇或者过于天真的妄想之处，也可能因为自身知识能力的关系视野狭隘没有看清各大游戏厂商的设计思维。所以还请多多包涵指点，聊以娱乐。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://ty-chen.github.io/2020/04/18/%E5%85%B3%E4%BA%8EMMORPG%E5%A4%9A%E4%BA%BA%E5%AF%B9%E6%88%98%E4%B8%AD%E7%83%AD%E7%82%B9%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF%E8%AE%A8%E8%AE%BA/" data-id="ck96e9xkr0001ystt00ibfqaf" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list" itemprop="keywords"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-NS《集合啦动物森友会》联机系统硬核分析及优化讨论" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/04/18/NS%E3%80%8A%E9%9B%86%E5%90%88%E5%95%A6%E5%8A%A8%E7%89%A9%E6%A3%AE%E5%8F%8B%E4%BC%9A%E3%80%8B%E8%81%94%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%A1%AC%E6%A0%B8%E5%88%86%E6%9E%90%E5%8F%8A%E4%BC%98%E5%8C%96%E8%AE%A8%E8%AE%BA/" class="article-date">
  <time datetime="2020-04-18T13:55:28.504Z" itemprop="datePublished">2020-04-18</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/04/18/NS%E3%80%8A%E9%9B%86%E5%90%88%E5%95%A6%E5%8A%A8%E7%89%A9%E6%A3%AE%E5%8F%8B%E4%BC%9A%E3%80%8B%E8%81%94%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%A1%AC%E6%A0%B8%E5%88%86%E6%9E%90%E5%8F%8A%E4%BC%98%E5%8C%96%E8%AE%A8%E8%AE%BA/">NS《集合啦动物森友会》联机系统硬核分析及优化讨论</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h3 id="一-联机系统简介"><a href="#一-联机系统简介" class="headerlink" title="一. 联机系统简介"></a>一. 联机系统简介</h3><p>&emsp;&emsp;集合啦动物森友会是最近NS的大爆款，我也第一时间入坑玩的不亦乐乎。在最近一周的游玩过程中，唯一被大家抱怨的问题大概就是这个联机系统了。首先我来简单介绍一下动物森友会的网络联机流程和中间的一些机制。<br><img src="https://img-blog.csdnimg.cn/20200329152545223.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3UwMTMzNTQ0ODY=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<ol>
<li>需要开通NS会员这肯定没啥好说的</li>
<li>去别的岛上逛或者别人来自己岛上逛只能二选一，不可以自己开着岛让别人来玩同时自己跑别人岛上玩</li>
<li>如果想去别人岛上玩，此时不允许岛上有人开着窗口</li>
<li>人数有限制，最多8人联机</li>
<li>岛上每来一个新游客，所有人都必须停下活动强行进入一个读取界面和一个从机场出来的动画界面</li>
<li>岛上每走一个游客，所有人都必须进入读取界面</li>
<li>当岛上一个人数据出现错误断开时，所有人均会断开并回档</li>
<li>当网络异常后，会自动关闭大门，想再让人过来需要再次开放</li>
<li>休眠自动关闭网络连接</li>
<li>动森没有云存档，所有存档存在本地 ，去别人岛玩的过程中只有在自己或别的游客进入、离开的时候才会触发存档</li>
<li>别人上岛玩的时候不可以装饰自己家、不可以改变地形、不可以进终端机操作</li>
<li>开启邀请别人上岛不可以寄明信片</li>
<li>岛主掉线大家都会断开</li>
</ol>
<h3 id="二-联机系统分析"><a href="#二-联机系统分析" class="headerlink" title="二. 联机系统分析"></a>二. 联机系统分析</h3><p>&emsp;&emsp;根据以上联机的流程和限制，我们可以大致做以下的猜测：</p>
<ol>
<li>联机系统一般分为两种，占用服务器资源的联机或P2P联机，根据机制4，12，13可以猜测大概率为P2P连接，具体需要后续wireshark抓包确认，由于采取科学上网+游戏加速器，这里可能会比较艰难。</li>
<li>如果是P2P的话，一般是用C/S模拟成peer，根据机制2可以知道此处不支持同时开启c和s模型，而是仅可以启动client或者server完成联机过程。如果是服务器联机，则说明这里会映射到一个服务端申请空间建立岛的备份或者进入一个别人建立的服务端备份岛中进行联机。在映射的整个过程中，发起者不允许访问别的映射而是必须等释放资源才可以。</li>
<li>机制3、5、6、7反应了动森的数据一致性处理机制，从中我们可以总结一下动森的一致性维护方式：我们用log表示每人的的存档状态，每次有人进来之前需要停止活动、关闭窗口以便于记录当前的log，如果有人掉线断开连接则所有人的log回滚到上一次有人进入时的状态（最后一次保存状态），如果有人离开则再次更新当前的log并保存。</li>
</ol>
<h3 id="三-改进分析"><a href="#三-改进分析" class="headerlink" title="三. 改进分析"></a>三. 改进分析</h3><p>&emsp;&emsp;很显然，这套联机系统是比较蛋疼的，最蛋疼的地方就在于每次有人来所有人都需要停下手中的活等着，有人掉线的话所有人都会回个档，那么有没有办法做改进呢？下面给出一些个人的想法。首先申明，怎么样做到不掉线不在本文讨论范围内，这个属于网络性能优化、科学上网和游戏加速器代理的知识，有空再单独聊。本文只针对掉线和不掉线可能带来的问题展开讨论。</p>
<h4 id="3-1-P2P联机系统"><a href="#3-1-P2P联机系统" class="headerlink" title="3.1 P2P联机系统"></a>3.1 P2P联机系统</h4><h5 id="3-1-1-实现方式分析"><a href="#3-1-1-实现方式分析" class="headerlink" title="3.1.1 实现方式分析"></a>3.1.1 实现方式分析</h5><p>&emsp;&emsp;如果是P2P联机，其实就是所有人以client方式连接开放权限的server，然后通过tcp(适合局域网)、udp或者utp等方式进行通信。这里又有两种实现方式</p>
<p>（1）以server为轴心和其他玩家通信：入岛玩家发消息、走路、做动作会实时发送数据包给server，并得到server回复其他几名玩家的位置信息、动作从而实现联机功能。</p>
<ul>
<li><p>优点：利于管理，小型server可以做到数据的汇总和一致性。</p>
</li>
<li><p>缺点：server本身会有比较大的负载，而且一旦崩了所有人GG。</p>
</li>
</ul>
<p>（2）中央服务器或者边缘CDN协调各个client和server的IP/PORT实现多点之间p2p，每次玩家移动会向其他的peer发送消息并得到其他玩家的回复，从而实现联机功能。</p>
<ul>
<li><p>优点：岛主所在的岛只是提供一个岛的数据，其他数据均来自于各个玩家，对server来说会压力较小，而且崩了也不会有太大影响。</p>
</li>
<li><p>缺点：数据会较为凌乱，无法很好地进行一致性处理。网络本身是不稳定的，每个玩家的延迟也不同，比如玩家A发送给BCD自己向前跑了十步并丢下了1000颗大头菜，BC玩家在几百毫秒内收到并出现了动画，而D玩家迟迟没有收到。</p>
</li>
</ul>
<h5 id="3-1-2-实现方式改进"><a href="#3-1-2-实现方式改进" class="headerlink" title="3.1.2 实现方式改进"></a>3.1.2 实现方式改进</h5><p>&emsp;&emsp;根据动森的联机表现来看，如果是P2P联机系统则采用的显然是第一种方式。而这里有必要做log的一致性到这种地步吗？我觉得是没有的。下面针对岛主、游客来分析可能存在哪些问题，以及可能有哪些解决方案。</p>
<p>（1）关于数据一致性和先后顺序的判定</p>
<p>&emsp;&emsp;对于分布式系统，解决数据一致性和先后顺序显然是有很多方法的。针对这里最多8人的设定，采取raft或paxos的思想做一致性保证，由岛主发布其他接收即可。如果出现log丢失，只需要照着最新的log写入就行，甚至不需要做leader election。而玩家操作的先后顺序就更简单了，采取lamport clock或者vector clock可以轻松解决。</p>
<p>（2）对于岛主来说，其他玩家登陆岛的操作过程和自身操作修改岛可以共存吗？</p>
<p>&emsp;&emsp;应该是可以的。这里我们可以在开启了server后，定时记录岛的变化，如果有玩家的client连入，发送最新的岛status，如果在玩家连入过程中出现对岛status的操作，则追加一个包。玩家的坐飞机过程为载入原status，落地动画阶段读取是否有新的变化，如果有的话立刻改变也不会有任何影响。</p>
<p>（3）对于岛主来说，其他玩家对岛的操作会实时发送消息，而这些消息可以收到立刻处理并发送给其他玩家。这里面可能出现的问题包括：</p>
<ul>
<li>没有收到消息</li>
<li>收到了消息，但是处理并发送时，其他玩家有些没有收到</li>
<li>新入岛的玩家正在接收当前岛的资料、岛上玩家信息和分布等，没有及时收到消息或者消息太多、消息排队过长被丢弃</li>
</ul>
<p>如何解决以上问题呢：</p>
<ul>
<li>没有收到消息可能是断线或者网络丢包。如果是断线直接回滚记录即可，如果是丢包没有收到ACK则重复发送几次，若依然没有收到则判断为断线，走断线逻辑操作</li>
<li>解决方法类似于上一条，利用ACK判断掉线逻辑</li>
<li>这里是NS的机制规避的一大问题，我们可以参考（1）中的做法，在坐飞机过程读取来之前那一刻server的数据集，然后在这过程中发生的变化则依次记录，最后在统一在动画时间发送给新来的玩家。</li>
</ul>
<p>（4）对于岛主来说，游客上岛可以自己离岛去玩耍吗？</p>
<p>&emsp;&emsp;这里任天堂之所以没有做C/S并发，可能考虑到NS的机能限制决定，不然的话同时开启一个server套接字和一个client套接字并走两套逻辑应该不会有太大的问题。岛的数据状态和人物数据状态本身就是两套分开的体系。如果机能允许，我想不出任何理由不做该系统。虽然会较为复杂，但是对玩法提升会极为巨大。</p>
<p>（5）对于游客来说，上岛过程读取数据，动画结束后实时根据server发送的数据来处理各个玩家的操作、消息并刷新。这里没必要每一笔操作都发过去，而是只发去最后状态即可，所以数据量并不会大。离岛时保存自身状态即可，对岛屿其实没有太多影响，只是删去该人物的信息而已。这部分我想不到任何理由需要让所有人目送他离开。哪怕是要存档，也着实没理由一起观看动画。</p>
<p>（6）关于数据统一和存档的问题。</p>
<p>&emsp;&emsp;目前动森采取有人进入、离开时统一存档的方式。优点就在于简单不容易出岔子，缺点太多了不说了。其实动森已经实现了闲时保存和主动保存功能，但是并没有提供给联机模式。如果直接提供给联机模式用会有问题吗？其实我觉得不会有问题。</p>
<p>&emsp;&emsp;有人会说如果不严格管理的话，玩家存档不一致怎么办？其实是不存在这个问题的。</p>
<p>&emsp;&emsp;岛的数据（玩家定位、玩家穿着、岛的装饰、玩家扔东西采东西等）可以单独维护，每个人的操作都会修改岛的数据并发送给其他玩家来改变其他玩家当前显示的岛的表现，这一过程只要不掉线一定是可以维持的，只是延迟问题，如果掉线更不用考虑。而岛的数据仅属于岛主，和其他人的存档毫无关系。由于岛的数据仅有一份在岛主这里，其他人的写入过程只有岛主收到了才有效。</p>
<p>&emsp;&emsp;假设有人在地上丢了个东西，岛主保存游戏并退出，在岛主退出时如果有人捡了东西，则岛主重连后东西还在发生了错误，这种情况其实是不存在的。因为有人捡东西是需要岛主ACK才可以的，不然会触发掉线回档，没有ACK的情况下是不允许立刻保存的，或者说点击保存会触发尚未ACK的消息再次请求回应的过程。</p>
<p>&emsp;&emsp;每个玩家的数据（包裹，金钱，衣服）即我们关心的存档是存在本地的，在别人岛上游玩过程中，对该存档可能产生的变化就是别人给你东西或者你给别人东西。比如A丢个东西在地上，让B拾取，大致是这么个流程：A丢东西动作—-&gt;server接收到发给所有其他玩家—–&gt;B看到东西被A丢地上，捡起来——&gt;server接收到B的动作发给所有其他玩家，server断线没啥好说的，大家都GG，存档也会回档到上一次存档，如果server正常，A或者B掉线对自身影响是动作失效并断开连接，对对方来说其实并无影响。</p>
<h4 id="3-2-服务器联机系统"><a href="#3-2-服务器联机系统" class="headerlink" title="3.2 服务器联机系统"></a>3.2 服务器联机系统</h4><p>&emsp;&emsp;服务器联机和P2P的区别在于服务端位于服务器还是岛主上。服务器联机的话，机房是一笔很大的开销，而如果能将每个岛开岛的时候映射到服务器，或者干脆每个岛都直接搭在服务器上，则是对整个联机过程最大的提升（没错MMORPG新游，集合啦动物森友会）。其实优化提升的分析和P2P相似，但是对于岛主来说更为自由，对于游客来说也是如此。岛主的掉线不再会直接导致所有人的掉线。缺点在于成本高，所以短时间内大概不要想啦，就算有，国服也是遥遥无期，也许任天堂的下一代动森作品会出呢。</p>
<h3 id="四-总结"><a href="#四-总结" class="headerlink" title="四. 总结"></a>四. 总结</h3><p>&emsp;&emsp;综上，任天堂其实是有很多选择的方案将动森的联机系统做的更加出众，让玩家玩起来更为舒心的。但是他没有做，原因大概只有赶工期，迁就一下了，毕竟做如此精妙的博物馆、家具系统、岛屿生态系统、玩法系统还是极为不容易的，所以只能用最简单的做法做到还可以接受的效果，满足一下大家联机的心愿。但是不论如何，作为世界的主宰，这个联机系统还是挺让人失望的。</p>
<p>&emsp;&emsp;本文是我在玩游戏之余因为买不到大头菜的愤懑而做，可能存在很多偏颇和缺陷，也可能因为自身知识能力的关系视野狭隘没有看清任天堂的设计思维。所以还请多多包涵指点，聊以娱乐。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="https://ty-chen.github.io/2020/04/18/NS%E3%80%8A%E9%9B%86%E5%90%88%E5%95%A6%E5%8A%A8%E7%89%A9%E6%A3%AE%E5%8F%8B%E4%BC%9A%E3%80%8B%E8%81%94%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%A1%AC%E6%A0%B8%E5%88%86%E6%9E%90%E5%8F%8A%E4%BC%98%E5%8C%96%E8%AE%A8%E8%AE%BA/" data-id="ck96e9xkl0000ysttg3txd03q" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  


</section>
        
          <aside id="sidebar">
  
    

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">标签云</h3>
    <div class="widget tagcloud">
      <a href="/tags/%E9%9A%8F%E7%AC%94/" style="font-size: 10px;">随笔</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">归档</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/04/">四月 2020</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">最新文章</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/04/18/%E5%85%B3%E4%BA%8EMMORPG%E5%A4%9A%E4%BA%BA%E5%AF%B9%E6%88%98%E4%B8%AD%E7%83%AD%E7%82%B9%E9%97%AE%E9%A2%98%E7%9A%84%E8%A7%A3%E5%86%B3%E6%80%9D%E8%B7%AF%E8%AE%A8%E8%AE%BA/">关于MMORPG多人对战中热点问题的解决思路讨论</a>
          </li>
        
          <li>
            <a href="/2020/04/18/NS%E3%80%8A%E9%9B%86%E5%90%88%E5%95%A6%E5%8A%A8%E7%89%A9%E6%A3%AE%E5%8F%8B%E4%BC%9A%E3%80%8B%E8%81%94%E6%9C%BA%E7%B3%BB%E7%BB%9F%E7%A1%AC%E6%A0%B8%E5%88%86%E6%9E%90%E5%8F%8A%E4%BC%98%E5%8C%96%E8%AE%A8%E8%AE%BA/">NS《集合啦动物森友会》联机系统硬核分析及优化讨论</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 Ty Chen<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  
<link rel="stylesheet" href="/fancybox/jquery.fancybox.css">

  
<script src="/fancybox/jquery.fancybox.pack.js"></script>




<script src="/js/script.js"></script>




  </div>
</body>
</html>