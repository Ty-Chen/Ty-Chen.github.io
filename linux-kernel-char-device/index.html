<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/kulamati128.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/kulamati32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/kulamati16.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Linux,操作系统,文件系统,设备驱动,字符设备," />










<meta name="description" content="一. 前言&amp;emsp;&amp;emsp;上文中我们分析了虚拟文件系统的结构以及常见的文件操作从用户态到虚拟文件系统再到底层实际文件系统的过程。而实际上我们并没有说明实际的文件系统如ext4是如何和磁盘进行交互的，这就是本文和下篇文章的重点：I&#x2F;O之块设备和字符设备。输入输出设备我们大致可以分为两类：块设备（Block Device）和字符设备（Character Device）。  块设备将信息存储在固">
<meta property="og:type" content="article">
<meta property="og:title" content="Linux操作系统学习笔记（十三）字符设备">
<meta property="og:url" content="https://ty-chen.github.io/linux-kernel-char-device/index.html">
<meta property="og:site_name" content="Ty-Chen&#39;s Home">
<meta property="og:description" content="一. 前言&amp;emsp;&amp;emsp;上文中我们分析了虚拟文件系统的结构以及常见的文件操作从用户态到虚拟文件系统再到底层实际文件系统的过程。而实际上我们并没有说明实际的文件系统如ext4是如何和磁盘进行交互的，这就是本文和下篇文章的重点：I&#x2F;O之块设备和字符设备。输入输出设备我们大致可以分为两类：块设备（Block Device）和字符设备（Character Device）。  块设备将信息存储在固">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/80/7f/80e152fe768e3cb4c84be62ad8d6d07f.jpg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/2e/e6/2e29767e84b299324ea7fc524a3dcee6.jpeg">
<meta property="og:image" content="https://static001.geekbang.org/resource/image/c3/1d/c3498dad4f15712529354e0fa123c31d.jpeg">
<meta property="article:published_time" content="2020-06-23T16:02:47.000Z">
<meta property="article:modified_time" content="2020-07-18T05:53:40.719Z">
<meta property="article:author" content="Ty Chen">
<meta property="article:tag" content="Linux">
<meta property="article:tag" content="操作系统">
<meta property="article:tag" content="文件系统">
<meta property="article:tag" content="设备驱动">
<meta property="article:tag" content="字符设备">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://static001.geekbang.org/resource/image/80/7f/80e152fe768e3cb4c84be62ad8d6d07f.jpg">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"hide","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="https://ty-chen.github.io/linux-kernel-char-device/"/>





  <title>Linux操作系统学习笔记（十三）字符设备 | Ty-Chen's Home</title>
  








<meta name="generator" content="Hexo 4.2.0"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Ty-Chen's Home</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Collecting, sharing and creating knowledge</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://ty-chen.github.io/linux-kernel-char-device/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Ty Chen">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/me.JPG">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ty-Chen's Home">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Linux操作系统学习笔记（十三）字符设备</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-24T00:02:47+08:00">
                2020-06-24
              </time>
            

            

            
          </span>
          
            <span class="post-updated">
              &nbsp; | &nbsp; 更新于
              <time itemprop="dateUpdated" datetime="2020-07-18T13:53:40+08:00" content="2020-07-18">
                2020-07-18
              </time>
            </span>
          
          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Linux%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F%E5%86%85%E6%A0%B8%E5%AD%A6%E4%B9%A0/" itemprop="url" rel="index">
                    <span itemprop="name">Linux操作系统内核学习</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/linux-kernel-char-device/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count valine-comment-count" data-xid="/linux-kernel-char-device/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv">访问次数：
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>次
            </span>
          

          
            <div class="post-wordcount">
              
                
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">字数统计&#58;</span>
                
                <span title="字数统计">
                  4.2k
                </span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">
                  17
                </span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="一-前言"><a href="#一-前言" class="headerlink" title="一. 前言"></a>一. 前言</h2><p>&emsp;&emsp;上文中我们分析了虚拟文件系统的结构以及常见的文件操作从用户态到虚拟文件系统再到底层实际文件系统的过程。而实际上我们并没有说明实际的文件系统如ext4是如何和磁盘进行交互的，这就是本文和下篇文章的重点：I/O之块设备和字符设备。输入输出设备我们大致可以分为两类：块设备（Block Device）和字符设备（Character Device）。</p>
<ul>
<li><p>块设备将信息存储在固定大小的块中，每个块都有自己的地址。如硬盘就是常见的块设备。</p>
</li>
<li><p>字符设备发送或接收的是字节流，而不用考虑任何块结构，没有办法寻址。如鼠标就是常见的字符设备。</p>
</li>
</ul>
<p>&emsp;&emsp;本文首先介绍虚拟文件系统下层直至硬件输入输出设备的结构关系，然后重点分析字符设备相关的整体逻辑情况。</p>
<a id="more"></a>

<h2 id="二-I-O架构"><a href="#二-I-O架构" class="headerlink" title="二. I/O架构"></a>二. I/O架构</h2><p>&emsp;&emsp;由于各种输入输出设备具有不同的硬件结构、驱动程序，因此我们采取了设备控制器这一中间层对上提供统一接口。设备控制器通过缓存来处理CPU和硬件I/O之间的交互关系，通过中断进行通知，因此我们需要有中断处理器对各种中断进行统一。由于每种设备的控制器的寄存器、缓冲区等使用模式，指令都不同，所以对于操作系统还需要一层对接各个设备控制器的设备驱动程序。</p>
<p>&emsp;&emsp;这里需要注意的是，设备控制器不属于操作系统的一部分，但是设备驱动程序属于操作系统的一部分。操作系统的内核代码可以像调用本地代码一样调用驱动程序的代码，而驱动程序的代码需要发出特殊的面向设备控制器的指令，才能操作设备控制器。设备驱动程序中是一些面向特殊设备控制器的代码，不同的设备不同。但是对于操作系统其它部分的代码而言，设备驱动程序有统一的接口。</p>
<img src="https://static001.geekbang.org/resource/image/80/7f/80e152fe768e3cb4c84be62ad8d6d07f.jpg" alt="img" style="zoom:33%;" />

<p>&emsp;&emsp;设备驱动本身作为一个内核模块，通常以<code>ko</code>文件的形式存在，它有着其独特的代码结构：</p>
<ul>
<li><p>头文件部分。设备驱动程序至少需要以下头文件</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/module.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;linux/init.h&gt;</span></span></span><br></pre></td></tr></table></figure>
</li>
<li><p>调用<code>MODULE_LICENSE</code>声明<code>lisence</code></p>
</li>
<li><p>初始化函数<code>module_init</code>和退出函数<code>module_exit</code>的定义，用于加载和卸载<code>ko</code>文件</p>
</li>
<li><p>文件系统的接口<code>file_operation</code>结构体定义</p>
</li>
<li><p>定义需要的函数</p>
</li>
</ul>
<p>&emsp;&emsp;在下文的分析中，我们就将按照此顺序来剖析字符设备的源码，以弄懂字符设备的一般运行逻辑。关于设备驱动代码编写的详细知识可以参考《Linux设备驱动》一书，本文重点不在于如何编写代码，而是在于操作系统中的字符设备和块设备如何工作。</p>
<h2 id="三-字符设备基本构成"><a href="#三-字符设备基本构成" class="headerlink" title="三. 字符设备基本构成"></a>三. 字符设备基本构成</h2><p>&emsp;&emsp;一个字符设备由3个部分组成：</p>
<ul>
<li>封装对于外部设备的操作的设备驱动程序，即 <code>ko</code> 文件模块，里面有模块初始化函数、中断处理函数、设备操作函数等。加载设备驱动程序模块的时候，模块初始化函数会被调用。在内核维护所有字符设备驱动的数据结构 <code>cdev_map</code> 里面注册设备号后，我们就可以很容易根据设备号找到相应的设备驱动程序。</li>
<li>特殊的设备驱动文件系统 <code>devtmpfs</code>，在/dev 目录下生成一个文件表示这个设备。打开一个字符设备文件和打开一个普通的文件有类似的数据结构，有文件描述符、有 <code>struct file</code>、指向字符设备文件的 <code>dentry</code> 和 <code>inode</code>。其对应的 <code>inode</code> 是一个特殊的 <code>inode</code>，里面有设备号。通过它我们可以在 <code>cdev_map</code> 中找到设备驱动程序，里面还有针对字符设备文件的默认操作 <code>def_chr_fops</code>。</li>
<li>字符设备文件的相关操作 <code>file_operations</code> 。一开始会指向 <code>def_chr_fops</code>，在调用 <code>def_chr_fops</code> 里面的 <code>chrdev_open</code> 函数的时候修改为指向设备操作函数，从而读写一个字符设备文件就会直接变成读写外部设备了。</li>
</ul>
<p>&emsp;&emsp;这里主要涉及到了两个结构体：字符设备信息存储的<code>struct cdev</code>以及管理字符设备的<code>cdev_map</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span>                  <span class="comment">//内嵌的内核对象.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span>                 <span class="comment">//该字符设备所在的内核模块的对象指针.</span></span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">ops</span>;</span>    <span class="comment">//该结构描述了字符设备所能实现的方法，是极为关键的一个结构体.</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>                <span class="comment">//用来将已经向内核注册的所有字符设备形成链表.</span></span><br><span class="line">    <span class="keyword">dev_t</span> dev;                            <span class="comment">//字符设备的设备号，由主设备号和次设备号构成.</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> count;                   <span class="comment">//隶属于同一主设备号的次设备号的个数.</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;<code>cdev</code>结构体还有另一个相关联的结构体<code>char_device_struct</code>。这里首先会定义主设备号和次设备号：主设备号用来标识与设备文件相连的驱动程序，用来反映设备类型。次设备号被驱动程序用来辨别操作的是哪个设备，用来区分同类型的设备。这里<code>minorct</code>指的是分配的区域，用于主设备号和次设备号的分配工作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">char_device_struct</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">char_device_struct</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> major;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> baseminor;</span><br><span class="line">    <span class="keyword">int</span> minorct;</span><br><span class="line">    <span class="keyword">char</span> name[<span class="number">64</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> *<span class="title">cdev</span>;</span>		<span class="comment">/* will die */</span></span><br><span class="line">&#125; *chrdevs[CHRDEV_MAJOR_HASH_SIZE];</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;<code>cdev_map</code>用于维护所有字符设备驱动，实际是结构体<code>kobj_map</code>，主要包括了一个互斥锁<code>lock</code>，一个<code>probes[255]</code>数组，数组元素为<code>struct probe</code>的指针，该结构体包括链表项、设备号、设备号范围等。所以我们将字符设备驱动最后保存为一个<code>probe</code>，并用<code>cdev_map/kobj_map</code>进行统一管理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">kobj_map</span> *<span class="title">cdev_map</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kobj_map</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">probe</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">probe</span> *<span class="title">next</span>;</span></span><br><span class="line">        <span class="keyword">dev_t</span> dev;</span><br><span class="line">        <span class="keyword">unsigned</span> <span class="keyword">long</span> range;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">module</span> *<span class="title">owner</span>;</span></span><br><span class="line">        <span class="keyword">kobj_probe_t</span> *<span class="built_in">get</span>;</span><br><span class="line">        <span class="keyword">int</span> (*lock)(<span class="keyword">dev_t</span>, <span class="keyword">void</span> *);</span><br><span class="line">        <span class="keyword">void</span> *data;</span><br><span class="line">    &#125; *probes[<span class="number">255</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mutex</span> *<span class="title">lock</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h2 id="四-打开字符设备"><a href="#四-打开字符设备" class="headerlink" title="四. 打开字符设备"></a>四. 打开字符设备</h2><p>&emsp;&emsp;字符设备有很多种，这里以打印机设备为输出设备的例子，源码位于<code>drivers/char/lp.c</code>。以鼠标为输入设备的例子，源码位于<code>drivers/input/mouse/logibm.c</code>。下面将根据上述的字符设备的三个组成部分分别剖析如何创建并打开字符设备。</p>
<h3 id="4-1-加载"><a href="#4-1-加载" class="headerlink" title="4.1 加载"></a>4.1 加载</h3><p>&emsp;&emsp;字符设备的使用从加载开始，通常我们会使用<code>insmod</code>命令或者<code>modprobe</code>命令加载<code>ko</code>文件，<code>ko</code>文件的加载则从<code>module_init</code>调用该设备自定义的初始函数开始。对于打印机来说，其初始化函数定义为<code>lp_init_module()</code>，实际调用<code>lp_init()</code>。<code>lp_init()</code>会初始化打印机结构体，并调用<code>register_chardev()</code>注册该字符设备。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">module_init(lp_init_module);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">lp_init_module</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">return</span> lp_init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">lp_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">if</span> (register_chrdev(LP_MAJOR, <span class="string">"lp"</span>, &amp;lp_fops)) &#123;</span><br><span class="line">        printk(KERN_ERR <span class="string">"lp: unable to get major %d\n"</span>, LP_MAJOR);</span><br><span class="line">        <span class="keyword">return</span> -EIO;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>register_chrdev()</code>实际调用<code>__register_chrdev()</code>，该函数会进行字符设备的注册操作。其主要逻辑如下</p>
<ul>
<li>调用<code>__register_chrdev_region()</code>注册字符设备的主设备号和名称</li>
<li>调用<code>cdev_alloc()</code>分配结构体<code>struct cdev</code></li>
<li>将 <code>cdev</code> 的 <code>ops</code> 成员变量指向这个模块声明的 <code>file_operations</code></li>
<li>调用<code>cdev_add()</code>将这个字符设备添加到结构体 <code>struct kobj_map *cdev_map</code> ，该结构体用于统一管理所有字符设备。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">inline</span> <span class="keyword">int</span> <span class="title">register_chrdev</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> major, <span class="keyword">const</span> <span class="keyword">char</span> *name,</span></span></span><br><span class="line"><span class="function"><span class="params">                  <span class="keyword">const</span> struct file_operations *fops)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> __register_chrdev(major, <span class="number">0</span>, <span class="number">256</span>, name, fops);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">int</span> __register_chrdev(<span class="keyword">unsigned</span> <span class="keyword">int</span> major, <span class="keyword">unsigned</span> <span class="keyword">int</span> baseminor,</span><br><span class="line">              <span class="keyword">unsigned</span> <span class="keyword">int</span> count, <span class="keyword">const</span> <span class="keyword">char</span> *name,</span><br><span class="line">              <span class="keyword">const</span> struct file_operations *fops)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">char_device_struct</span> *<span class="title">cd</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> *<span class="title">cdev</span>;</span></span><br><span class="line">    <span class="keyword">int</span> err = -ENOMEM;</span><br><span class="line">    cd = __register_chrdev_region(major, baseminor, count, name);</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(cd))</span><br><span class="line">        <span class="keyword">return</span> PTR_ERR(cd);</span><br><span class="line">    cdev = cdev_alloc();</span><br><span class="line">    <span class="keyword">if</span> (!cdev)</span><br><span class="line">        <span class="keyword">goto</span> out2;</span><br><span class="line">    cdev-&gt;owner = fops-&gt;owner;</span><br><span class="line">    cdev-&gt;ops = fops;</span><br><span class="line">    kobject_set_name(&amp;cdev-&gt;kobj, <span class="string">"%s"</span>, name);</span><br><span class="line">    err = cdev_add(cdev, MKDEV(cd-&gt;major, baseminor), count);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 拼接ma和mi</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MINORBITS	20</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> MKDEV(ma,mi)	(((ma) &lt;&lt; MINORBITS) | (mi))</span></span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;对于鼠标来说，加载也是类似的：注册为<code>logibm_init()</code>函数。但是这里没有调用<code>register_chrdev()</code>而是使用<code>input_register_device()</code>，原因在于输入设备会统一由<code>input_init()</code>初始化，之后加入的输入设备通过<code>input_register_device()</code>注册到<code>input</code>的管理结构体中进行统一管理。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">module_init(logibm_init);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> __init <span class="title">logibm_init</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">    err = input_register_device(logibm_dev);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="4-2-创建文件设备"><a href="#4-2-创建文件设备" class="headerlink" title="4.2 创建文件设备"></a>4.2 创建文件设备</h3><p>&emsp;&emsp;加载完<code>ko</code>文件后，Linux内核会通过<code>mknod</code>在/dev目录下创建一个设备文件，只有有了这个设备文件，我们才能通过文件系统的接口对这个设备文件进行操作。<code>mknod</code>本身是一个系统调用，主要逻辑为调用<code>user_path_create()</code>为该设备文件创建<code>dentry</code>，然后对于<code>S_IFCHAR</code>或者<code>S_IFBLK</code>会调用<code>vfs_mknod()</code>去调用对应文件系统的操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(mknod, <span class="keyword">const</span> <span class="keyword">char</span> __user *, filename, <span class="keyword">umode_t</span>, mode, <span class="keyword">unsigned</span>, dev)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">return</span> sys_mknodat(AT_FDCWD, filename, mode, dev);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE4(mknodat, <span class="keyword">int</span>, dfd, <span class="keyword">const</span> <span class="keyword">char</span> __user *, filename, <span class="keyword">umode_t</span>, mode,</span><br><span class="line">    <span class="keyword">unsigned</span>, dev)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dentry</span> *<span class="title">dentry</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">path</span> <span class="title">path</span>;</span></span><br><span class="line">......</span><br><span class="line">    dentry = user_path_create(dfd, filename, &amp;path, lookup_flags);</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">switch</span> (mode &amp; S_IFMT) &#123;</span><br><span class="line">......</span><br><span class="line">        <span class="keyword">case</span> S_IFCHR: <span class="keyword">case</span> S_IFBLK:</span><br><span class="line">            error = vfs_mknod(path.dentry-&gt;d_inode,dentry,mode,</span><br><span class="line">            new_decode_dev(dev));</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">......</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">vfs_mknod</span><span class="params">(struct inode *dir, struct dentry *dentry, <span class="keyword">umode_t</span> mode, <span class="keyword">dev_t</span> dev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">......</span><br><span class="line">    error = dir-&gt;i_op-&gt;mknod(dir, dentry, mode, dev);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;对于<code>/dev</code>目录下的设备驱动来说，所属的文件系统为<code>devtmpfs</code>文件系统，即设备驱动临时文件系统。<code>devtmpfs</code>对应的文件系统定义如下</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_system_type</span> <span class="title">dev_fs_type</span> = &#123;</span> </span><br><span class="line">    .name = <span class="string">"devtmpfs"</span>, </span><br><span class="line">    .mount = dev_mount, </span><br><span class="line">    .kill_sb = kill_litter_super,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct dentry *<span class="title">dev_mount</span><span class="params">(struct file_system_type *fs_type, <span class="keyword">int</span> flags, </span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">const</span> <span class="keyword">char</span> *dev_name, <span class="keyword">void</span> *data)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TMPFS </span></span><br><span class="line">    <span class="keyword">return</span> mount_single(fs_type, flags, data, shmem_fill_super);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">else</span> return </span></span><br><span class="line">    mount_single(fs_type, flags, data, ramfs_fill_super);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;从这里可以看出，<code>devtmpfs</code> 在挂载的时候有两种模式：一种是 <code>ramfs</code>，一种是 <code>shmem</code> ，都是基于内存的文件系统。这两个 <code>mknod</code> 虽然实现不同，但是都会调用到同一个函数 <code>init_special_inode()</code>。显然这个文件是个特殊文件，<code>inode</code> 也是特殊的。这里这个 <code>inode</code> 可以关联字符设备、块设备、FIFO 文件、Socket 等。我们这里只看字符设备。这里的 <code>inode</code> 的 <code>file_operations</code> 指向一个 <code>def_chr_fops</code>，这里面只有一个 <code>open</code>，就等着你打开它。另外，<code>inode</code> 的 <code>i_rdev</code> 指向这个设备的 <code>dev_t</code>。通过这个 <code>dev_t</code>，可以找到我们刚刚加载的字符设备 <code>cdev</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inode_operations</span> <span class="title">ramfs_dir_inode_operations</span> = &#123;</span></span><br><span class="line">......</span><br><span class="line">  .mknod    = ramfs_mknod,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">inode_operations</span> <span class="title">shmem_dir_inode_operations</span> = &#123;</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_TMPFS</span></span><br><span class="line">......</span><br><span class="line">  .mknod    = shmem_mknod,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">init_special_inode</span><span class="params">(struct inode *inode, <span class="keyword">umode_t</span> mode, <span class="keyword">dev_t</span> rdev)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    inode-&gt;i_mode = mode;</span><br><span class="line">    <span class="keyword">if</span> (S_ISCHR(mode)) &#123;</span><br><span class="line">        inode-&gt;i_fop = &amp;def_chr_fops;</span><br><span class="line">        inode-&gt;i_rdev = rdev;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (S_ISBLK(mode)) &#123;</span><br><span class="line">        inode-&gt;i_fop = &amp;def_blk_fops;</span><br><span class="line">        inode-&gt;i_rdev = rdev;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (S_ISFIFO(mode))</span><br><span class="line">        inode-&gt;i_fop = &amp;pipefifo_fops;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (S_ISSOCK(mode))</span><br><span class="line">        ;  <span class="comment">/* leave it no_open_fops */</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        printk(KERN_DEBUG <span class="string">"init_special_inode: bogus i_mode (%o) for"</span></span><br><span class="line">                  <span class="string">" inode %s:%lu\n"</span>, mode, inode-&gt;i_sb-&gt;s_id,</span><br><span class="line">                  inode-&gt;i_ino);    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> <span class="title">def_chr_fops</span> = &#123;</span></span><br><span class="line">    .<span class="built_in">open</span> = chrdev_open,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;由此我们完成了<code>/dev</code>下文件的创建，并利用<code>rdev</code>和生成的字符设备进行了关联。</p>
<h3 id="4-3-打开字符设备"><a href="#4-3-打开字符设备" class="headerlink" title="4.3 打开字符设备"></a>4.3 打开字符设备</h3><p>&emsp;&emsp;如打开普通文件一样，打开字符设备也会首先分配对应的文件描述符<code>fd</code>，然后生成<code>struct file</code>结构体与其绑定，并将<code>file</code>关联到对应的<code>dentry</code>从而可以接触<code>inode</code>。在进程里面调用 <code>open()</code> 函数，最终会调用到这个特殊的 <code>inode</code> 的 <code>open()</code> 函数，也就是 <code>chrdev_open()</code>。</p>
<p>&emsp;&emsp;<code>chrdev_open()</code>主要逻辑为</p>
<ul>
<li>调用<code>kobj_lookup()</code>，通过设备号<code>i_cdev</code>关联对应的设备驱动程序</li>
<li>调用<code>fops_get()</code>将设备驱动程序自己定义的文件操作<code>p-&gt;ops</code>赋值给<code>fops</code></li>
<li>调用设备驱动程序的 <code>file_operations</code> 的 <code>open()</code> 函数真正打开设备。对于打印机，调用的是 <code>lp_open()</code>。对于鼠标调用的是 <code>input_proc_devices_open()</code>，最终会调用到 <code>logibm_open()</code>。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Called every time a character special file is opened</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">chrdev_open</span><span class="params">(struct inode *inode, struct file *filp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">fops</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> *<span class="title">p</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">cdev</span> *<span class="title">new</span> = <span class="title">NULL</span>;</span></span><br><span class="line">......</span><br><span class="line">    p = inode-&gt;i_cdev;</span><br><span class="line">......</span><br><span class="line">    kobj = kobj_lookup(cdev_map, inode-&gt;i_rdev, &amp;idx);</span><br><span class="line">......      </span><br><span class="line">    fops = fops_get(p-&gt;ops);</span><br><span class="line">......</span><br><span class="line">    replace_fops(filp, fops);</span><br><span class="line">    <span class="keyword">if</span> (filp-&gt;f_op-&gt;<span class="built_in">open</span>) &#123;</span><br><span class="line">        ret = filp-&gt;f_op-&gt;<span class="built_in">open</span>(inode, filp);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述过程借用极客时间中的图来作为总结。</p>
<p><img src="https://static001.geekbang.org/resource/image/2e/e6/2e29767e84b299324ea7fc524a3dcee6.jpeg" alt="img"></p>
<h2 id="五-写入字符设备"><a href="#五-写入字符设备" class="headerlink" title="五. 写入字符设备"></a>五. 写入字符设备</h2><p>&emsp;&emsp;写入字符设备和写入普通文件一样，调用<code>write()</code>函数执行。该函数在内核里查询系统调用表最终调用<code>sys_write()</code>，并根据<code>fd</code>描述符获取对应的<code>file</code>结构体，接着调用<code>vfs_write()</code>去调用对应的文件系统自定义的写入函数<code>file-&gt;f_op-&gt;write()</code>。对于打印机来说，最终调用的是自定义的<code>lp_write()</code>函数。</p>
<p>&emsp;&emsp;这里写入的重点在于调用 <code>copy_from_user()</code> 将数据从用户态拷贝到内核态的缓存中，然后调用 <code>parport_write()</code> 写入外部设备。这里还有一个 <code>schedule()</code> 函数，也即写入的过程中，给其他线程抢占 CPU 的机会。如果写入字节数多，不能一次写完，就会在循环里一直调用 <code>copy_from_user()</code> 和 <code>parport_write()</code>，直到写完为止。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">ssize_t</span> <span class="title">lp_write</span><span class="params">(struct file *file, <span class="keyword">const</span> <span class="keyword">char</span> __user *buf,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">size_t</span> count, <span class="keyword">loff_t</span> *ppos)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">unsigned</span> <span class="keyword">int</span> minor = iminor(file_inode(file));</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">parport</span> *<span class="title">port</span> = <span class="title">lp_table</span>[<span class="title">minor</span>].<span class="title">dev</span>-&gt;<span class="title">port</span>;</span></span><br><span class="line">    <span class="keyword">char</span> *kbuf = lp_table[minor].lp_buffer;</span><br><span class="line">    <span class="keyword">ssize_t</span> retv = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">ssize_t</span> written;</span><br><span class="line">    <span class="keyword">size_t</span> copy_size = count;</span><br><span class="line">......</span><br><span class="line">    <span class="comment">/* Need to copy the data from user-space. */</span></span><br><span class="line">    <span class="keyword">if</span> (copy_size &gt; LP_BUFFER_SIZE)</span><br><span class="line">        copy_size = LP_BUFFER_SIZE;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">if</span> (copy_from_user(kbuf, buf, copy_size)) &#123;</span><br><span class="line">        retv = -EFAULT;</span><br><span class="line">        <span class="keyword">goto</span> out_unlock;</span><br><span class="line">    &#125;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">/* Write the data. */</span></span><br><span class="line">        written = parport_write(port, kbuf, copy_size);</span><br><span class="line">        <span class="keyword">if</span> (written &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            copy_size -= written;</span><br><span class="line">            count -= written;</span><br><span class="line">            buf  += written;</span><br><span class="line">            retv += written;</span><br><span class="line">        &#125;</span><br><span class="line">......</span><br><span class="line">        <span class="keyword">if</span> (need_resched())</span><br><span class="line">            schedule(); </span><br><span class="line">        <span class="keyword">if</span> (count) &#123;</span><br><span class="line">            copy_size = count;</span><br><span class="line">            <span class="keyword">if</span> (copy_size &gt; LP_BUFFER_SIZE)</span><br><span class="line">                copy_size = LP_BUFFER_SIZE;</span><br><span class="line">            <span class="keyword">if</span> (copy_from_user(kbuf, buf, copy_size)) &#123;</span><br><span class="line">                <span class="keyword">if</span> (retv == <span class="number">0</span>)</span><br><span class="line">                    retv = -EFAULT;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">while</span> (count &gt; <span class="number">0</span>);</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="六-字符设备的控制"><a href="#六-字符设备的控制" class="headerlink" title="六. 字符设备的控制"></a>六. 字符设备的控制</h2><p>&emsp;&emsp;在Linux中，我们常用<code>ioctl()</code>来对I/O设备进行一些读写之外的特殊操作。其参数主要由文件描述符<code>fd</code>，命令<code>cmd</code>以及命令参数<code>arg</code>构成。其中cmd由几个部分拼接成整型，主要结构为</p>
<ul>
<li>最低8位为 NR，表示命令号；</li>
<li>次低8位为 TYPE，表示类型；</li>
<li>14位表示参数的大小；</li>
<li>最高2位是 DIR，表示写入、读出，还是读写。</li>
</ul>
<img src="https://static001.geekbang.org/resource/image/c3/1d/c3498dad4f15712529354e0fa123c31d.jpeg" alt="img" style="zoom: 33%;" />

<p>&emsp;&emsp;<code>ioctl()</code>也是一个系统调用，其中<code>fd</code> 是这个设备的文件描述符，<code>cmd</code> 是传给这个设备的命令，<code>arg</code> 是命令的参数。主要调用<code>do_vfs_ioctl()</code>完成实际功能。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">SYSCALL_DEFINE3(ioctl, <span class="keyword">unsigned</span> <span class="keyword">int</span>, fd, <span class="keyword">unsigned</span> <span class="keyword">int</span>, cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span>, arg)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">int</span> error;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">fd</span> <span class="title">f</span> = <span class="title">fdget</span>(<span class="title">fd</span>);</span></span><br><span class="line">......</span><br><span class="line">    error = do_vfs_ioctl(f.file, fd, cmd, arg);</span><br><span class="line">    fdput(f);</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;<code>do_vfs_ioctl()</code>对于已经定义好的 <code>cmd</code>进行相应的处理。如果不是默认定义好的 <code>cmd</code>，则执行默认操作：对于普通文件，调用 <code>file_ioctl</code>，对于其他文件调用 <code>vfs_ioctl</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * When you add any new common ioctls to the switches above and below</span></span><br><span class="line"><span class="comment"> * please update compat_sys_ioctl() too.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * do_vfs_ioctl() is not for drivers and not intended to be EXPORT_SYMBOL()'d.</span></span><br><span class="line"><span class="comment"> * It's just a simple helper for sys_ioctl and compat_sys_ioctl.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_vfs_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> fd, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd,</span></span></span><br><span class="line"><span class="function"><span class="params">         <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> error = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> __user *argp = (<span class="keyword">int</span> __user *)arg;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">inode</span> *<span class="title">inode</span> = <span class="title">file_inode</span>(<span class="title">filp</span>);</span></span><br><span class="line">    <span class="keyword">switch</span> (cmd) &#123;</span><br><span class="line">    <span class="keyword">case</span> FIOCLEX:</span><br><span class="line">        set_close_on_exec(fd, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FIONCLEX:</span><br><span class="line">        set_close_on_exec(fd, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FIONBIO:</span><br><span class="line">        error = ioctl_fionbio(filp, argp);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> FIOASYNC:</span><br><span class="line">        error = ioctl_fioasync(fd, filp, argp);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">if</span> (S_ISREG(inode-&gt;i_mode))</span><br><span class="line">            error = file_ioctl(filp, cmd, arg);</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            error = vfs_ioctl(filp, cmd, arg);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;对于字符设备驱动程序，最终会调用<code>vfs_ioctl()</code>。这里面调用的是 <code>struct file</code> 里 <code>file_operations</code> 的 <code>unlocked_ioctl()</code> 函数。我们前面初始化设备驱动的时候，已经将 <code>file_operations</code> 指向设备驱动的 <code>file_operations</code> 了。这里调用的是设备驱动的 <code>unlocked_ioctl</code>。对于打印机程序来讲，调用的是 <code>lp_ioctl()</code>。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">long</span> <span class="title">vfs_ioctl</span><span class="params">(struct file *filp, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd, <span class="keyword">unsigned</span> <span class="keyword">long</span> arg)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> error = -ENOTTY;</span><br><span class="line">    <span class="keyword">if</span> (!filp-&gt;f_op-&gt;unlocked_ioctl)</span><br><span class="line">        <span class="keyword">goto</span> out;</span><br><span class="line">    error = filp-&gt;f_op-&gt;unlocked_ioctl(filp, cmd, arg);</span><br><span class="line">    <span class="keyword">if</span> (error == -ENOIOCTLCMD)</span><br><span class="line">        error = -ENOTTY;</span><br><span class="line"> out:</span><br><span class="line">    <span class="keyword">return</span> error;</span><br><span class="line">&#125; EXPORT_SYMBOL(vfs_ioctl);</span><br></pre></td></tr></table></figure>

<p>&emsp;&emsp;打印机的<code>lp_do_ioctl()</code>主要逻辑也是针对<code>cmd</code>采用<code>switch()</code>语句分情况进行处理。主要包括使用<code>LP_XXX()</code>宏定义赋值标记位和调用<code>copy_to_user()</code>将用户想得到的信息返回给用户态。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">lp_do_ioctl</span><span class="params">(<span class="keyword">unsigned</span> <span class="keyword">int</span> minor, <span class="keyword">unsigned</span> <span class="keyword">int</span> cmd,</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">unsigned</span> <span class="keyword">long</span> arg, <span class="keyword">void</span> __user *argp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> status;</span><br><span class="line">    <span class="keyword">int</span> retval = <span class="number">0</span>;</span><br><span class="line">......</span><br><span class="line">    <span class="keyword">switch</span> ( cmd ) &#123;</span><br><span class="line">        <span class="keyword">case</span> LPTIME:</span><br><span class="line">            <span class="keyword">if</span> (arg &gt; UINT_MAX / HZ)</span><br><span class="line">                <span class="keyword">return</span> -EINVAL;</span><br><span class="line">            LP_TIME(minor) = arg * HZ/<span class="number">100</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LPCHAR:</span><br><span class="line">            LP_CHAR(minor) = arg;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> LPABORT:</span><br><span class="line">            <span class="keyword">if</span> (arg)</span><br><span class="line">                LP_F(minor) |= LP_ABORT;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                LP_F(minor) &amp;= ~LP_ABORT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    ......</span><br><span class="line">        <span class="keyword">case</span> LPGETIRQ:</span><br><span class="line">            <span class="keyword">if</span> (copy_to_user(argp, &amp;LP_IRQ(minor),</span><br><span class="line">                    <span class="keyword">sizeof</span>(<span class="keyword">int</span>)))</span><br><span class="line">                <span class="keyword">return</span> -EFAULT;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>&emsp;&emsp;本文简单介绍了设备驱动程序的结构，并在此基础上介绍了字符设备从创建到打开、写入以及控制的整个流程。</p>
<h2 id="源码资料"><a href="#源码资料" class="headerlink" title="源码资料"></a>源码资料</h2><p>[1] <a href="https://code.woboq.org/linux/linux/drivers/char/lp.c.html" target="_blank" rel="noopener">lp.c</a></p>
<p>[2] <a href="https://code.woboq.org/linux/linux/fs/char_dev.c.html" target="_blank" rel="noopener">char_dev</a></p>
<p>[3] <a href="https://code.woboq.org/linux/linux/fs/ioctl.c.html#39" target="_blank" rel="noopener">ioctl</a></p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p>[1] wiki</p>
<p>[2] <a href="https://elixir.bootlin.com/linux/v5.7-rc1/source" target="_blank" rel="noopener">elixir.bootlin.com/linux</a></p>
<p>[3] <a href="https://code.woboq.org/" target="_blank" rel="noopener">woboq</a></p>
<p>[4] Linux-insides</p>
<p>[5] 深入理解Linux内核</p>
<p>[6] Linux内核设计的艺术</p>
<p>[7] 极客时间 趣谈Linux操作系统</p>
<p>[8] Linux设备驱动程序</p>

      
    </div>
    
    
    

    

    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>坚持原创，坚持分享，谢谢鼓励和支持</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.png" alt="Ty Chen 微信支付"/>
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="Ty Chen 支付宝"/>
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    
      <div>
        <ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者：</strong>
    Ty Chen
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://ty-chen.github.io/linux-kernel-char-device/" title="Linux操作系统学习笔记（十三）字符设备">https://ty-chen.github.io/linux-kernel-char-device/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>
    本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/3.0/" rel="external nofollow" target="_blank">CC BY-NC-SA 3.0</a> 许可协议。转载请注明出处！
  </li>
</ul>

      </div>
    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Linux/" rel="tag"># Linux</a>
          
            <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" rel="tag"># 操作系统</a>
          
            <a href="/tags/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/" rel="tag"># 文件系统</a>
          
            <a href="/tags/%E8%AE%BE%E5%A4%87%E9%A9%B1%E5%8A%A8/" rel="tag"># 设备驱动</a>
          
            <a href="/tags/%E5%AD%97%E7%AC%A6%E8%AE%BE%E5%A4%87/" rel="tag"># 字符设备</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/linux-kernel-vfs/" rel="next" title="Linux操作系统学习笔记（十二）虚拟文件系统">
                <i class="fa fa-chevron-left"></i> Linux操作系统学习笔记（十二）虚拟文件系统
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/linux-kernel-block-device/" rel="prev" title="Linux操作系统学习笔记（十四）块设备">
                Linux操作系统学习笔记（十四）块设备 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
        
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

      
    </div>
  </div>


          </div>
          


          

  
    <div class="comments" id="comments">
    </div>
  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/me.JPG"
                alt="Ty Chen" />
            
              <p class="site-author-name" itemprop="name">Ty Chen</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">26</span>
                  <span class="site-state-item-name">日志</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">4</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">48</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Ty-Chen" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:tianyuch@hotmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          
            <div class="links-of-blogroll motion-element links-of-blogroll-inline">
              <div class="links-of-blogroll-title">
                <i class="fa  fa-fw fa-link"></i>
                Friends
              </div>
              <ul class="links-of-blogroll-list">
                
                  <li class="links-of-blogroll-item">
                    <a href="https://stanleylsx.github.io/" title="Stanleylsx" target="_blank">Stanleylsx</a>
                  </li>
                
              </ul>
            </div>
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#一-前言"><span class="nav-text">一. 前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二-I-O架构"><span class="nav-text">二. I&#x2F;O架构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三-字符设备基本构成"><span class="nav-text">三. 字符设备基本构成</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四-打开字符设备"><span class="nav-text">四. 打开字符设备</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#4-1-加载"><span class="nav-text">4.1 加载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-2-创建文件设备"><span class="nav-text">4.2 创建文件设备</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#4-3-打开字符设备"><span class="nav-text">4.3 打开字符设备</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五-写入字符设备"><span class="nav-text">五. 写入字符设备</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六-字符设备的控制"><span class="nav-text">六. 字符设备的控制</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#总结"><span class="nav-text">总结</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#源码资料"><span class="nav-text">源码资料</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考资料"><span class="nav-text">参考资料</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ty Chen</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">Site words total count&#58;</span>
    
    <span title="Site words total count">121.8k</span>
  
  <a href="http://www.beian.miit.gov.cn/" target="_blank" rel="noopener">粤ICP备20071543号</a> 
</div>









        
<div class="busuanzi-count">
	<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js">
	</script>

  
    <span class="site-uv">
      你是来访的第
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      位同学
    </span>
  

  
    <span class="site-pv">
      访问次数：
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      次
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  










  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail,link';
    guest = guest.split(',').filter(item=>{
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: false,
        notify: false,
        appId: 'aTqo2eFkO2Bn0AGX008uKDV7-gzGzoHsz',
        appKey: 'uJ6nxqW7RHWpAILCtttkJfJu',
        placeholder: 'Just go go',
        avatar:'mm',
        guest_info:guest,
        pageSize:'10' || 10,
    });
  </script>



  





  

  

  

  
  

  

  

  

</body>
</html>
